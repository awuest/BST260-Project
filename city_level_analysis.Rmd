---
title: "US Cities - National Level Trends"
author: "Rowana Ahmed"
date: "11/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Visualize national level trends & model relationships between breast cancer mortality
and preventive screening methods (mammography usage) across U.S. cities

```{r}
library(readxl)
library(tidyverse)
library(maps)
library(gridExtra)
library(stringr)
```


#### Load Data

```{r}
dat <- read_excel('./data/city_total_data.xlsx')
```

## Part I: Regression Analysis between Mammogram Usage & Breast Cancer Mortality

### A. Exploratory Data Analysis for Regression Model

The outcome (breast cancer mortality) and primary covariates (mammogram usage) are mostly normally distributed. Breast cancer mortality does have some extreme values in the right tail. 
```{r}

p1 <- dat %>% ggplot() +
        geom_histogram(aes(mammouse_crudeprev), col = 1) 

p2 <- dat %>% ggplot() +
        geom_histogram(aes(mammouse_adjprev), col = 1) 

p3 <- dat %>% ggplot() +
        geom_histogram(aes(breast_cancer_deaths_total_population), col = 1) 


grid.arrange(p1, p2, p3, nrow =1 )


```


The loess curves indicate that there is an inverse relationship between mammography screenings and breast cancer mortality for both the crude & age adjusted mammography usage rates. Because the age adjusted mammography usage rate is better representative of the city population, we will be using this for the analysis moving forward. 

```{r}


p1 <- dat %>% ggplot(aes(mammouse_adjprev, breast_cancer_deaths_total_population)) +
        geom_point() +
        geom_smooth()  

p2 <- dat %>% ggplot(aes(mammouse_crudeprev, breast_cancer_deaths_total_population)) + 
        geom_point() +
        geom_smooth()  


grid.arrange(p1, p2, nrow =1 )


```

There seems to be a slight positive relationship between the raw number of mammography sites in a city and mammography usage, particularly at the lower number of sites (<10). 

However, after accounting for the varying population sizes in a city, a stronger positive
relationship seems to be present when looking at the correlation between sites per 1000 people in the population and the age adjusted mammography usage rate.


```{r}
p1 <- dat %>% ggplot(aes(number_sites, mammouse_adjprev)) + 
        geom_point() +
        geom_smooth()

dat <- dat %>% mutate(sites_per_1000 = number_sites/(population2010/1000))
p2  <-   dat %>% 
        ggplot(aes(sites_per_1000, mammouse_adjprev)) + 
        geom_point() +
        geom_smooth()

grid.arrange(p1, p2, nrow =1 )


```




### B. Linear Regression Model


Initial Model fit examining relationship between mammography usage & breast cancer deaths
```{r}
red_mod <- lm(breast_cancer_deaths_total_population ~ mammouse_adjprev, data = dat)
summary(red_mod)
```


Expanded model accounting for racial diversity & racial segregation factors. 

The F-Test comparing the two model fits indicate that the full model is needed to explain the variance of the outcome (p<0.05), and the AIC score of the full model is lower than the reduced model (full model AIC 3149.091, reduced model AIC 3198.022), indicating that the full model better fits the observed data. 
```{r}

full_mod <- lm(breast_cancer_deaths_total_population ~ mammouse_adjprev + 
               racial_ethnic_diversity_total_population +
               I(racial_ethnic_diversity_total_population**2) + 
               neighborhood_racial_ethnic_segregation_total_population + 
               unemployment_annual_neighborhood_level_total_population, 
          data = dat)
summary(full_mod)
```

```{r}
anova(red_mod, full_mod)
```

```{r}
library(gam)
AIC(full_mod)
AIC(red_mod)
```

### C. Model Diagnostics

The residuals are mostly randomly scattered with a few outliers where the observed breast cancer deaths
are much greater than the predicted values from the model. This is also seen in the qq plot where 
the residuals appear right skewed. This departure from normality does limit the accuracy of the standard errors
of the beta coefficients, and may result in biased confidence interval calculations. However, the beta coefficients themselves are unbiased. 

The leverage plot also shows that there are some potentially influential points in the dataset, which might
be disproportionately driving the estimated coefficients. However, because we are relying on publicly available data, and do not have cause to believe there was measurement error or aberrant behavior explaining the influential points, we will use all data points to estimate the beta coefficients of the multiple linear
regression model. 

```{r}

plot(full_mod)
```

### D. Model Summary 




## Part II: National Trends

There are clear racial disparities in the rates of breast cancer deaths across the US cities,
with Blacks experiencing much higher rates of breast cancer deaths than all other racial groups and the national average.

# / TO DO - if include in shiny app, can have additional info per racial group on unemployment rates, uninsured rates, prenatal care, low birthweight, limited access to healthy food, etc.  

```{r}

cols <- names(dat)[str_detect(names(dat),'breast_cancer_death')]

dat %>% select(cols) %>% pivot_longer(cols = cols,
                                      names_to = "population", values_to = "deaths") %>% 
             mutate(population = str_replace(population, "breast_cancer_deaths_", "")) %>%
             mutate(population = str_replace(population, "total_population", "all")) %>% 
             ggplot() + 
             geom_violin(aes(population, deaths, fill = population), alpha = 0.5) +
             geom_hline(yintercept= 24.4, lty = 2, col = 'grey') +   
             geom_text(label = "national average", x = "asian", y= 27, hjust = "center",
                       col = 8, size = 3.3) + 
             ylab("deaths per 100,000 females") + 
             ggtitle("Breast Cancer Deaths across US Cities") 
                          
                         
```

National Map

# color by mammouse_adjprev/breast cancer mortality
# overlay facilities

Other screening: corew_adjprev, paptest_adjprev



